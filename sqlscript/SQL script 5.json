{
	"name": "SQL script 5",
	"properties": {
		"content": {
			"query": "Create external data source ADLSHack2\nWITH \n( LOCATION = 'abfss://rawzone@openhackec44.dfs.core.windows.net',\n\tTYPE = HADOOP\n)\n\nCREATE EXTERNAL FILE FORMAT csv\nWith\n( FORMAT_TYPE = DELIMITEDTEXT,\n  FORMAT_OPTIONS (\n\tFIELD_TERMINATOR = '|'\n    )\n)\n\nCREATE EXTERNAL FILE FORMAT Parquet WITH (FORMAT_TYPE = PARQUET)\nGO\n\n\nDROP external table ext_catalog\nCREATE EXTERNAL TABLE ext_catalog\n(\n        [SourceSystemId] VARCHAR(2),\n\t\t[SourceSystemMovieId] VARCHAR(38),\n\t\t[SouthridgeMovieId] VARCHAR(38),\n\t\t[PhysicalAvailabilityDate] DATETIME,\n\t\t[StreamingAvailabilityDate] DATETIME,\n\t\t[Genre] VARCHAR(50),\n\t\t[Title] VARCHAR(255),\n\t\t[Rating] VARCHAR(10),\n\t\t[RuntimeMinutes] BIGINT,\n\t\t[TheatricalReleaseYear] BIGINT,\n        [ActorName] VARCHAR(100),\n\t\t[ActorId] VARCHAR(38),\n        [ActorGender] CHAR(1),\n\t\t[CatalogId] VARCHAR(38)\n)\nWITH\n(\n    LOCATION = N'Normalized/catalog',\n    DATA_SOURCE = ADLSHack2,\n    FILE_FORMAT = Parquet,\n    REJECT_TYPE = VALUE,\n    REJECT_VALUE = 0\n)\nGO\n\nselect top 5 * from ext_catalog\n\n---------------------------DIM RATING--------------------------------------------------------------------\nSELECT DISTINCT [Rating] FROM ext_Catalog\n\n-- Output: PG-13, G, R, PG=13, PG\n-- Notice the typo of PG=13. The business would likely want to cleanse this for reporting purposes.\n\nDECLARE @MaxSK INTEGER;\nSELECT @MaxSK = ISNULL(MAX(MovieRatingSK),0) FROM [dbo].DimRatings\n\nINSERT INTO [dbo].DimRatings(\n\tMovieRatingDescription,\n\tMovieRatingSK)\nSELECT * FROM (\n\tSELECT \n\t\tc.Rating AS MovieRatingDescription,\n\t\t@MaxSK + ROW_NUMBER() OVER (ORDER BY c.Rating) AS MovieRatingSK\n\tFROM \n\t\t(SELECT\n\t\t\tDISTINCT CASE\n\t\t\t\tWHEN [Rating] = 'PG=13' THEN 'PG-13'\n\t\t\t\tELSE [Rating]\n\t\t\tEND AS Rating\n\t\tFROM\n\t\t\text_catalog) c\n) CleansedRatings\nWHERE\n\tCleansedRatings.MovieRatingDescription NOT IN (SELECT MovieRatingDescription FROM [dbo].DimRatings)\n\nSELECT * FROM [dbo].DimRatings\n\n---------------------------DIM Actors--------------------------------------------------------------------\nDECLARE @MaxSK INTEGER;\nSELECT @MaxSK = ISNULL(MAX(ActorSK),0) FROM [dbo].DimActors\n\nINSERT INTO dimActors\n\tSELECT @MaxSK + ROW_NUMBER() OVER (ORDER BY ActorID)\n    AS ActorSK,ActorID,ActorName,ActorGender from ext_catalog\n\nSELECT * from dimActors\n\n---------------------------DIM Actors--------------------------------------------------------------------\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"name": "openhackdec44",
				"type": "SqlPool"
			}
		},
		"type": "SqlQuery"
	}
}